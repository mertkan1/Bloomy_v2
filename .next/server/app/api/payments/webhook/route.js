"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},5297:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>x,staticGenerationAsyncStorage:()=>_});var o={};t.r(o),t.d(o,{POST:()=>m});var s=t(9303),a=t(8716),i=t(670),n=t(7070),p=t(3114),u=t(4738),d=t(650);let c=new p.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"}),l=process.env.STRIPE_WEBHOOK_SECRET;async function m(e){try{let r;let t=await e.text(),o=e.headers.get("stripe-signature");try{r=c.webhooks.constructEvent(t,o,l)}catch(e){return console.error("Webhook signature verification failed:",e),n.NextResponse.json({error:"Invalid signature"},{status:400})}if("checkout.session.completed"===r.type){let e=r.data.object,t=e.metadata,o=(0,u.eI)("https://hejgnhjmywsjklfnmmyp.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),s=(0,d.rK)(),{data:a,error:i}=await o.from("orders").insert({id:crypto.randomUUID(),user_id:t.userId,gift_code:s,plan:t.plan,recipient_email:t.recipientEmail,recipient_name:JSON.parse(t.giftData).recipientName,sender_name:JSON.parse(t.giftData).senderName,flower_id:JSON.parse(t.giftData).flower.id,themes:JSON.parse(t.giftData).selectedThemes||[],delivery_date:t.deliveryDate,status:"active",tokens_remaining:"365"===t.plan?1e3:100,stripe_session_id:e.id,amount_paid:e.amount_total}).select().single();if(i)return console.error("Order creation error:",i),n.NextResponse.json({error:"Failed to create order"},{status:500});let p=JSON.parse(t.giftData).flower;p.isLimited&&await o.rpc("decrement_flower_stock",{flower_id:p.id}),console.log("Order created successfully:",a.id)}return n.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),n.NextResponse.json({error:"Webhook handler failed"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"C:\\Users\\mertk\\Desktop\\BLOOMY\\bold\\Bloomy_v2\\app\\api\\payments\\webhook\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:_,serverHooks:x}=h,g="/api/payments/webhook/route";function v(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:_})}},650:(e,r,t)=>{t.d(r,{cn:()=>a,rK:()=>i});var o=t(5761),s=t(2386);function a(...e){return(0,s.m6)((0,o.W)(e))}function i(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r="";for(let t=0;t<8;t++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[948,760,972,114,86],()=>t(5297));module.exports=o})();